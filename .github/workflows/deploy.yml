# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: CI/CD GitHub Actions for GreetingsEarth

on:
  workflow_dispatch:
      
jobs:
  env:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        sparse-checkout: templates/prod.bicep

    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Apply Bicep template
      run: az deployment group create --resource-group GreetingsEarth --template-file ./templates/prod.bicep

  deploy:
    runs-on: ubuntu-latest
    needs: [env]    

    steps:
    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Download deployment package
      uses: actions/download-artifact@v4
      with:
        name: GreetingsEarth.zip

    - name: Publish to Azure App Service
      run: az webapp deploy --resource-group GreetingsEarth --name GreetingsEarth --src-path GreetingsEarth.zip --type zip
